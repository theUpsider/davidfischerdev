version: '3.8'

services:
  frontend:
    image: ghcr.io/theupsider/davidfischerdev:latest
    restart: unless-stopped
    env_file:
      - stack.env
    volumes:
      - blog-data:/app/data
    labels:
      - 'traefik.enable=true'
      - 'traefik.docker.network=traefik_net'
      - 'traefik.http.routers.davidfischerdev.tls=true'
      - 'traefik.http.routers.davidfischerdev.rule=Host(`davidfischer.dev`) || Host(`www.davidfischer.dev`)'
      - 'traefik.http.routers.davidfischerdev.entrypoints=https'
      - 'traefik.http.routers.davidfischerdev.tls.certresolver=simpleresolver'
      - 'traefik.http.services.davidfischerdev.loadbalancer.server.port=3000'

      # Rate limiting middleware for login endpoint
      - 'traefik.http.middlewares.login-ratelimit.ratelimit.average=5'
      - 'traefik.http.middlewares.login-ratelimit.ratelimit.period=1m'
      - 'traefik.http.middlewares.login-ratelimit.ratelimit.burst=10'

      # Router specifically for login/admin paths with rate limiting
      - 'traefik.http.routers.davidfischerdev-login.rule=Host(`davidfischer.dev`,`www.davidfischer.dev`) && (PathPrefix(`/blog/admin`) || PathPrefix(`/api/auth`))'
      - 'traefik.http.routers.davidfischerdev-login.entrypoints=https'
      - 'traefik.http.routers.davidfischerdev-login.tls=true'
      - 'traefik.http.routers.davidfischerdev-login.tls.certresolver=simpleresolver'
      - 'traefik.http.routers.davidfischerdev-login.middlewares=login-ratelimit'
      - 'traefik.http.routers.davidfischerdev-login.priority=100'
      - 'traefik.http.routers.davidfischerdev-login.service=davidfischerdev'
    networks:
      - traefik_net

networks:
  traefik_net:
    name: 'traefik_net'
    external: true

volumes:
  blog-data:
    name: davidfischerdev-blog-data
